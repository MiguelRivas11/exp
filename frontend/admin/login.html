<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iniciar Sesi√≥n - CityCare</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=PT+Sans:wght@400;700&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="style_login.css">

</head>

<body data-theme="light">
    <button class="theme-toggle" id="theme-toggle" aria-label="Cambiar tema">
        <i class="material-icons">dark_mode</i>
    </button>

    <button class="language-toggle" id="language-toggle" aria-label="Cambiar idioma">
        ES
    </button>

    <div class="login-container">
        <!-- Left Panel - Illustration -->
        <div class="login-illustration">
            <div class="illustration-content">
                <div class="logo">
                    <i class="material-icons logo-icon">location_city</i>
                    <span class="logo-text">CityCare</span>
                </div>
                <p class="slogan">Gesti√≥n inteligente para ciudades m√°s seguras</p>
            </div>
            <div class="illustration-image"></div>
        </div>

        <!-- Right Panel - Form -->
        <div class="login-form-container">
            <div class="form-header">
                <div class="welcome-message" id="welcome-message"></div>
                <h1 class="form-title">Bienvenido a CityCare</h1>
                <p class="form-subtitle">Inicia sesi√≥n para continuar</p>
            </div>

            <form class="login-form" id="login-form">
                <div class="form-group">
                    <label for="email" class="form-label">Correo electr√≥nico</label>
                    <div class="input-container">
                        <i class="material-icons input-icon">email</i>
                        <input type="email" id="email" class="form-input" placeholder="correo@ejemplo.com"
                            aria-describedby="email-error" required>
                    </div>
                    <div id="email-error" class="error-message" aria-live="polite"></div>
                </div>

                <div class="form-group">
                    <label for="password" class="form-label">Contrase√±a</label>
                    <div class="input-container">
                        <i class="material-icons input-icon">lock</i>
                        <input type="password" id="password" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                            aria-describedby="password-error" required>
                        <button type="button" class="password-toggle" id="password-toggle"
                            aria-label="Mostrar contrase√±a">
                            <i class="material-icons">visibility</i>
                        </button>
                    </div>
                    <div id="password-error" class="error-message" aria-live="polite"></div>
                </div>

                <div class="form-options">
                    <div class="checkbox-container">
                        <input type="checkbox" id="remember" name="remember">
                        <label for="remember" class="checkbox-label">Recordar sesi√≥n</label>
                    </div>
                    <a href="#" class="forgot-password">¬øOlvidaste tu contrase√±a?</a>
                </div>

                <button type="submit" class="submit-button" id="submit-button">
                    <span>Iniciar sesi√≥n</span>
                    <div class="loader" id="loader"></div>
                </button>

                <div class="success-message" id="success-message">
                    <i class="material-icons" style="vertical-align: middle; margin-right: 5px;">check_circle</i>
                    <span id="success-text">Inicio de sesi√≥n exitoso. Redirigiendo...</span>
                </div>


            </form>

            <div class="form-footer">
                ¬© 2025 CityCare | Plataforma de Gesti√≥n Ciudadana
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Elements
            const loginForm = document.getElementById('login-form');
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            const passwordToggle = document.getElementById('password-toggle');
            const submitButton = document.getElementById('submit-button');
            const loader = document.getElementById('loader');
            const successMessage = document.getElementById('success-message');
            const successText = document.getElementById('success-text');
            const themeToggle = document.getElementById('theme-toggle');
            const languageToggle = document.getElementById('language-toggle');
            const welcomeMessage = document.getElementById('welcome-message');

            // Error message elements
            const emailError = document.getElementById('email-error');
            const passwordError = document.getElementById('password-error');

            // Set welcome message based on time of day
            function setWelcomeMessage() {
                const hour = new Date().getHours();
                let message = '';

                if (hour >= 5 && hour < 12) {
                    message = 'Buenos d√≠as, bienvenido a CityCare';
                } else if (hour >= 12 && hour < 18) {
                    message = 'Buenas tardes, listo para continuar con tu labor';
                } else {
                    message = 'Buenas noches, gracias por tu dedicaci√≥n';
                }

                welcomeMessage.textContent = message;
            }

            // Theme toggle functionality
            function initTheme() {
                const savedTheme = localStorage.getItem('citycare-theme') || 'light';
                document.body.setAttribute('data-theme', savedTheme);

                // Update icon based on theme
                const icon = themeToggle.querySelector('i');
                icon.textContent = savedTheme === 'light' ? 'dark_mode' : 'light_mode';
            }

            themeToggle.addEventListener('click', function () {
                const currentTheme = document.body.getAttribute('data-theme');
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';

                document.body.setAttribute('data-theme', newTheme);
                localStorage.setItem('citycare-theme', newTheme);

                // Update icon
                const icon = themeToggle.querySelector('i');
                icon.textContent = newTheme === 'light' ? 'dark_mode' : 'light_mode';
            });

            // Language toggle functionality
            languageToggle.addEventListener('click', function () {
                const currentLang = languageToggle.textContent;
                const newLang = currentLang === 'ES' ? 'EN' : 'ES';
                languageToggle.textContent = newLang;
            });

            // Password visibility toggle
            passwordToggle.addEventListener('click', function () {
                const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordInput.setAttribute('type', type);

                // Update icon
                const icon = passwordToggle.querySelector('i');
                icon.textContent = type === 'password' ? 'visibility' : 'visibility_off';
            });

            // Helper functions for error handling
            function showError(input, errorElement, message) {
                input.classList.add('error');
                errorElement.textContent = message;
                errorElement.classList.add('show');
            }

            function hideError(input, errorElement) {
                input.classList.remove('error');
                errorElement.classList.remove('show');
            }

            // ========== LOGIN SIMPLIFICADO ==========
            // ========== LOGIN SIMPLIFICADO Y MEJORADO ==========
            loginForm.addEventListener('submit', async function (e) {
                e.preventDefault();

                // Reset previous errors
                hideError(emailInput, emailError);
                hideError(passwordInput, passwordError);

                // Validaci√≥n b√°sica de campos vac√≠os
                if (!emailInput.value.trim() || !passwordInput.value.trim()) {
                    showError(emailInput, emailError, 'Todos los campos son requeridos');
                    showError(passwordInput, passwordError, 'Todos los campos son requeridos');
                    return;
                }

                // 1. CAPTURAR LA OPCI√ìN "RECORDAR SESI√ìN"
                // Buscamos el checkbox en el HTML (aseg√∫rate de que tenga id="remember")
                const isRemembered = document.getElementById('remember') ? document.getElementById('remember').checked : false;

                // Show loading state
                submitButton.disabled = true;
                loader.style.display = 'block';
                submitButton.querySelector('span').textContent = 'Autenticando...';

                try {
                    // üì° LLAMADA A LA API (Apuntando al Gateway Puerto 3000)
                    const response = await fetch('http://localhost:3000/api/auth/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            email: emailInput.value,
                            password: passwordInput.value,
                            rememberMe: isRemembered // <--- Enviamos la preferencia al servidor
                        })
                    });

                    const data = await response.json();

                    // ‚úÖ LOGIN EXITOSO
                    if (data.success) {
                        loader.style.display = 'none';
                        successText.textContent = data.message;
                        successMessage.classList.add('show');

                        // LIMPIEZA TOTAL (Para evitar conflictos con sesiones viejas)
                        localStorage.removeItem('citycare-token');
                        localStorage.removeItem('citycare-user');
                        localStorage.removeItem('citycare-auth');
                        sessionStorage.removeItem('citycare-token');
                        sessionStorage.removeItem('citycare-user');
                        sessionStorage.removeItem('citycare-auth');

                        // üíæ ALMACENAMIENTO INTELIGENTE
                        if (isRemembered) {
                            // Si eligi√≥ recordar: LocalStorage (Persistente)
                            localStorage.setItem('citycare-token', data.token);
                            localStorage.setItem('citycare-user', JSON.stringify(data.user));
                            localStorage.setItem('citycare-auth', 'true');
                        } else {
                            // Si NO eligi√≥ recordar: SessionStorage (Temporal)
                            sessionStorage.setItem('citycare-token', data.token);
                            sessionStorage.setItem('citycare-user', JSON.stringify(data.user));
                            sessionStorage.setItem('citycare-auth', 'true');
                        }

                        // üîÑ REDIRIGIR AL DASHBOARD
                        setTimeout(() => {
                            window.location.href = data.redirect || 'admin-dashboard.html';
                        }, 2000);

                    } else {
                        // ‚ùå ERROR EN LOGIN
                        loader.style.display = 'none';
                        submitButton.disabled = false;
                        submitButton.querySelector('span').textContent = 'Iniciar sesi√≥n';

                        showError(emailInput, emailError, data.message);
                        showError(passwordInput, passwordError, data.message);
                    }

                } catch (error) {
                    // üåê ERROR DE CONEXI√ìN
                    console.error('Error en login:', error);
                    loader.style.display = 'none';
                    submitButton.disabled = false;
                    submitButton.querySelector('span').textContent = 'Iniciar sesi√≥n';

                    showError(emailInput, emailError, 'Error de conexi√≥n con el servidor');
                    showError(passwordInput, passwordError, 'Verifica que la API est√© ejecut√°ndose');
                }
            });

            // // Auto-fill demo credentials for testing
            // function autoFillCredentials() {
            //     emailInput.value = 'admin@citycare.gov';
            //     passwordInput.value = 'admin123';
            // }

            // Check if user is already logged in
            function checkAuthStatus() {
                const isAuthenticated = localStorage.getItem('citycare-auth');
                if (isAuthenticated === 'true') {
                    // If already logged in, redirect to dashboard
                    window.location.href = 'admin-dashboard.html';
                }
            }

            // Initialize
            setWelcomeMessage();
            initTheme();
            checkAuthStatus();

            // For demo purposes, auto-fill credentials after a short delay
            setTimeout(autoFillCredentials, 1000);
        });
    </script>
</body>

</html>